@model Phorcys.Web.Models.ChecklistInstanceViewModel
@using Kendo.Mvc.UI

@{
    ViewData["Title"] = "Check List";
}

<section class="jumbotron text-center">
    <div class="container">
        <h1 class="jumbotron-heading">@Model.Title</h1>
    </div>
</section>

@Html.AntiForgeryToken()

<div class="row">
    <div class="col-12">
        @(
            Html.Kendo().Grid<Phorcys.Web.Models.ChecklistInstanceItemViewModel>()
                .Name("ChecklistInstanceGrid")
                .Columns(columns =>
                {
                    columns.Bound(i => i.ChecklistInstanceItemId)
                        .Hidden();
                    columns.Bound(i => i.SequenceNumber).Title("#").Width(80);
                    columns.Bound(i => i.IsChecked)
                        .Title("Checked")
                        .Width(120)
                        .ClientTemplate(
                            "<span class='k-checkbox-wrapper'>" +
                            "  <input type='checkbox' id='chk_#= ChecklistInstanceItemId #' class='k-checkbox k-checkbox-md k-rounded-md' #= IsChecked ? 'checked=\\\"checked\\\"' : '' # onchange='onChecklistCheckedChange(this)' />" +
                            "  <label class='k-checkbox-label' for='chk_#= ChecklistInstanceItemId #'></label>" +
                            "</span>"
                        )
                        .EditorTemplateName("ChecklistInstanceIsChecked");
                    columns.Bound(i => i.Title).Title("Item");
                })
                .Mobile()
                .Resizable(resize => resize.Columns(true))
                .ToolBar(toolbar =>
                {
                    toolbar.Excel();
                    toolbar.Pdf();
                    toolbar.Search();
                })
                .Editable(edit => edit.Mode(GridEditMode.InCell))
                .ColumnMenu(col => col.Filterable(true))
                .DataSource(ds => ds.Ajax()
                    .Batch(true)
                    .AutoSync(true)
                    .PageSize(40)
                    .Model(m =>
                    {
                        m.Id(i => i.ChecklistInstanceItemId);
                        m.Field(f => f.ChecklistInstanceItemId).Editable(false);
                        m.Field(f => f.SequenceNumber).Editable(false);
                        m.Field(f => f.Title).Editable(false);
                        m.Field(f => f.IsChecked);
                    })
                    .Read(read => read.Action("ChecklistInstanceItems_Read", "Checklist", new { id = Model.ChecklistId }))
                    .Update(update => update.Action("ChecklistInstanceItems_Update", "Checklist", new { checklistId = Model.ChecklistId }))
                )
                .Excel(excel => excel
                    .AllPages(true)
                    .FileName("ChecklistItems.xlsx")
                    .ProxyURL(Url.Action("Excel_Export_Save", "Grid")))
                .Pdf(pdf => pdf
                    .AllPages(true)
                    .FileName("ChecklistItems.pdf")
                    .ProxyURL(Url.Action("Excel_Export_Save", "Grid")))
                .Pageable(page => page
                    .ButtonCount(5)
                    .Refresh(true)
                    .PageSizes(new[] { 10, 20, 40, 80 }))
                .Sortable()
                .Groupable()
                .Filterable()
                .Scrollable()
        )
    </div>
</div>

<p class="mt-3">
    @(Html.Kendo().Button()
        .Name("cancelButton")
        .HtmlAttributes(new { @class = "btn btn-normal", onclick = "redirectToIndex();" })
        .ImageUrl(Url.Content("~/icons/RedXMark.png"))
        .Content("Cancel")
    )
</p>

<script>
    function redirectToIndex() {
        window.location.href = '@Url.Action("Index", "Checklist")';
    }

    function onChecklistCheckedChange(cb) {
        var grid = $("#ChecklistInstanceGrid").data("kendoGrid");
        var item = grid.dataItem($(cb).closest("tr"));
        if (!item) {
            return;
        }

        item.set("IsChecked", cb.checked);
    }
</script>

