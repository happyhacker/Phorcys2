@model Phorcys.Web.Models.ChecklistInstanceViewModel
@using Kendo.Mvc.UI

@{
    ViewData["Title"] = "Check List";
}

<section class="jumbotron text-center">
    <div class="container">
        <h1 class="jumbotron-heading">Check List</h1>
        <p class="lead text-muted">@Model.Title</p>
    </div>
</section>

@Html.AntiForgeryToken()

<div class="row">
    <div class="col-12">
        @(
            Html.Kendo().Grid<Phorcys.Web.Models.ChecklistInstanceItemViewModel>()
                .Name("ChecklistInstanceGrid")
                .Columns(columns =>
                {
                    columns.Bound(i => i.SequenceNumber)
                        .Title("#")
                        .Width(80);

                    columns.Bound(i => i.IsChecked)
                      .Title("Checked")
                      .Width(120)
                      .HtmlAttributes(new { style = "text-align:center;" })
                      .HeaderHtmlAttributes(new { style = "text-align:center;" })
                      .ClientTemplate(
                          "<input type='checkbox' " +
                          "#= IsChecked ? 'checked=\"checked\"' : '' # " +
                          "onchange='onChecklistCheckedChange(this)' />"
                      );

                    columns.Bound(i => i.Title)
                        .Title("Item");
                })
                .Editable(edit => edit.Mode(GridEditMode.InCell))
                .DataSource(ds => ds.Ajax()
                    .Batch(true)
                    .AutoSync(true)
                    .Model(m =>
                    {
                        // WARNING: SequenceNumber must be unique. Your screenshot shows duplicates.
                        // Replace with a real unique key if possible (e.g., ChecklistInstanceItemId).
                        m.Id(i => i.SequenceNumber);

                        m.Field(f => f.SequenceNumber).Editable(false);
                        m.Field(f => f.Title).Editable(false);
                        m.Field(f => f.IsChecked).Editable(true);
                    })
                    .Read(read => read.Action("ChecklistInstanceItems_Read", "Checklist", new { id = Model.ChecklistId }))
                    .Update(update => update.Action("ChecklistInstanceItems_Update", "Checklist", new { checklistId = Model.ChecklistId }))
                )
                .Mobile()
                .Resizable(resize => resize.Columns(true))
                .ToolBar(toolbar => {
                    toolbar.Excel();
                    toolbar.Pdf();
                    toolbar.Search();
                })
                .Pdf(pdf => pdf.ProxyURL(Url.Action("Excel_Export_Save", "Grid")))
                .Excel(excel => excel.ProxyURL(Url.Action("Excel_Export_Save", "Grid")))
                .ColumnMenu(col => col.Filterable(true))
                .Pageable(pageable => pageable
                    .ButtonCount(5)
                    .Refresh(true)
                    .PageSizes(new[] { 5, 10, 20, 40, 800 }))
                .Sortable()
                .Groupable()
                .Filterable()
                .Scrollable()
        )
    </div>
</div>

<p class="mt-3">
    <a class="btn btn-secondary" href="@Url.Action("Index", "Checklist")">Back to Checklists</a>
</p>

@section Scripts {
    <script>
        function onChecklistCheckedChange(cb) {
            var grid = $("#ChecklistInstanceGrid").data("kendoGrid");
            var dataItem = grid.dataItem($(cb).closest("tr"));
            if (!dataItem) return;

            dataItem.set("IsChecked", cb.checked);
        }
    </script>
}
